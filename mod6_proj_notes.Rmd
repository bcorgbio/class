---
title: "Module 6 Project Notes"
bibliography: class.bib
---
<style>
div.green { background-color:#c7d1c0; border-radius: 5px; padding: 20px;}
</style>

<!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# What I would've done

Load the data using our convention for many files. That is:

  + find files with `list.files()`
  + establish and empty list.
  + run a `for` loop to iterate through file names and read in data
  + strip metadata from file name and store it in columns of temporary tibble
  + store temporary tibble in the list
  
Notice I pull the files from a folder within the directory that contains the .Rmd.

```{r cars, message=FALSE, warning=FALSE}

library(tidyverse)
library(MuMIn)

f <- list.files(path = paste0(getwd(),"/proj6data"),pattern=".csv",full.names = T)

d.l <- list() #emply list

for(i in f){

  met <- unlist(strsplit(basename(i),"_"))
  time <- met[3]
  mass <- as.numeric(gsub(".csv","",met[4]))
  
  d.l[[basename(i)]] <- read_csv(i)%>%
    mutate(team=met[1],subject=met[2],time=time,mass=mass*1000) #note mass converted to grams, same for M&L04
}


```

Now we can combine all the data in the list, group by subject, time, and mass, then summarize with `mean()`. Then, pivot the table wider (with names from time and values from the mean temp calculation) so that we can later find the difference between day and night temperatures. 

```{r}

dat <- do.call(rbind,d.l)%>%
  group_by(subject,time,mass)%>%
  summarize(m.temp=mean(Temp))%>%
  pivot_wider(names_from=time,values_from=m.temp)%>%
  mutate(t.diff=abs(day-night))%>%
  print
```
 
# Answering the First Question

 * What is the relationship between $T_{\Delta}$ and body mass in humans? I.e., is there a relationship and if so, is it allometric rather than isometric? Be sure to estimate important model parameters including scaling coefficients and slopes.


First, let's log transform the data and set it aside in a new tibble

```{r}

dat.log <- dat%>%
  select(subject,mass,t.diff)%>%
  mutate_at(c("mass","t.diff"),log)%>%
  print()
```

Now let's plot both  unstransformed data and log transformed:

```{r}
dat%>%
  ggplot(aes(mass,t.diff))+geom_point()+geom_smooth(method="lm")
```

<center>
**Fig. 1.** Plot of $T_{\Delta}$ vs mass in 30 human subjects.
</center>


```{r}
dat.log%>%
  ggplot(aes(mass,t.diff))+geom_point()+geom_smooth(method="lm")
```

<center>
**Fig. 2.** Plot of log-transformed $T_{\Delta}$ vs mass in 30 human subjects.
</center>


Doesn't look like we have much of a relationship. But let's run models and check it out.

```{r}
diff.lm <- lm(t.diff~mass,dat)
diff.loglm <- lm(t.diff~mass,dat.log)

lapply( list(diff.lm,diff.loglm),anova)
```

These are not significant relationships. But, if you had to, you could find which model fits best. Though, it'd be a pretty bad model nonetheless.

```{r}
AICc(diff.lm,diff.loglm)
```

There's definitely no clear relationship between $T_{\Delta}$ and mass in our human subjects. 


# Answering the Second Question

* What is the relationship between $T_{\Delta}$ and body mass across mammals, including humans?

First, let's read in the mammal data from @mortola2004scaling and do the same operations that we did on our data. Let's add our data, too, after computing mean mass and $T_{\Delta}$.

```{r}
m.dat <- read_csv("mammal.temp.csv")%>%
  mutate(t.diff=abs(T.high-T.low))%>%
  print()

dat.mean <- dat%>%
  mutate(Order="Primata",
        species="Homo sapien"
        )%>%
  group_by(Order,species)%>%
  summarize(mass.g=mean(mass,na.rm = T),t.diff=mean(t.diff,na.rm=T)) #remove NA in data 
  

  

m.dat <- m.dat%>%
  select(-T.high,-T.low)%>%
  rbind(dat.mean)%>%
  print()

#see if our data made it in.

tail(m.dat)

```

Now let's make a log-transformed tibble and, plot the relationships, and then construct linear and log-linear models and compare them.

```{r}
m.dat.log <- m.dat%>%
  mutate_at(c("mass.g","t.diff"),log)

mam.lm <- lm(t.diff~mass.g,m.dat)
mam.loglm <- lm(t.diff~mass.g,m.dat.log)

m.dat%>%
  ggplot(aes(mass.g,t.diff))+geom_point()+geom_smooth(method="lm")
```

<center>
**Fig. 3** Regression plot of amplitude of diel body temperature oscillations in mammals.
</center>

This totally looks wacky of course, because mammals span 6 orders of magnitude in terms of mass.

```{r}
m.dat.log%>%
  ggplot(aes(mass.g,t.diff))+geom_point()+geom_smooth(method="lm")
```
<center>
**Fig. 4** Log-log regression plot of amplitude of diel body temperature oscillations in mammals.
</center>

This is much better. 

Let's now compare the models with AICc.

```{r}
aics <- AICc(mam.lm,mam.loglm)

```
We see that the log-linear model fits much better. Is the relationship significant?

```{r}
m.log.anova <- anova(mam.loglm)%>%print()

```

The log relationship is significant. So now let's extract the coefficients (intercept and slope, i.e. scaling exponent)

```{r}
m.log.coef <- coef(mam.loglm)%>%print()

exp(m.log.coef[1])

```

M&L report a relationship of $T_{\Delta}=3.35C^oW^{0.13}$. Ours is $T_{\Delta}=2.93C^oW^{0.12}$, so pretty close.


# Answering the Third Question

* Does taxonomic group with respect to order effectively predict differences in this relationship across mammals?

Let's first replot our log-log data but know coloring points by order. We'll highlight out data for humans, too.

```{r}
m.dat.log%>%
  ggplot(aes(mass.g,t.diff,col=Order))+geom_point()+geom_smooth(method="lm")+geom_text(aes(mass.g,t.diff,label=species),m.dat.log%>%filter(species=="Homo sapien"))
```

Looks like we reproduced a good study for humans according to the primate trend! Nice work!!

Now let's assess the the model, comparing it to the simpler model.

```{r}
mam.order.lm <- lm(t.diff~mass.g*Order,m.dat.log)
AICc(mam.loglm,mam.order.lm)
```

The more complex model is a better fit. What about the significance of the effect of taxonomic order?
```{r}
anova(mam.order.lm)
```

We probably wanted to assume interactions with `*`. This interaction is significant which means the scaling exponent (slope of the log-log relationship) is affected by taxonomic order.

# References